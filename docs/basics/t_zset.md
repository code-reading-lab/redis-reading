---
sidebar_position: 9
---

# Redis源码分析 t_zset.c
在 Redis 源码库中，跳跃表的实现可以在 "server.h" 和 "t_zset.c" 文件中找到。

## 数据结构分析
server.h: 这个文件定义了跳跃表节点和跳跃表数据结构。跳跃表结构包括头指针、尾指针、长度和层级。跳跃表节点包括键、分数、向前指针和向后指针。
[链接](https://github.com/redis/redis/blob/7.2/src/server.h)
在 server.h 中，跳跃表的定义部分如下：

```c
typedef struct zskiplistNode {
    robj *obj;  // 节点的对象
    double score;  // 节点的分值
    struct zskiplistNode *backward;  // 后退指针
    struct zskiplistLevel {
        struct zskiplistNode *forward;  // 前进指针
        unsigned int span;  // 跨度
    } level[];
} zskiplistNode;

typedef struct zskiplist {
    struct zskiplistNode *header, *tail;  // 头节点和尾节点
    unsigned long length;  // 节点数量
    int level;  // 最大层数
} zskiplist;
```

上述代码中，`zskiplistNode` 结构体表示跳跃表的节点，包含了节点的成员对象和分值，以及前进指针、后退指针和跨度。跳跃表的层数是动态生成的，因此 `level` 是一个柔性数组，用于存储节点的前进指针和跨度信息。`zskiplist` 结构体表示跳跃表，包含了头节点、尾节点、节点数量和最大层数等信息。

跳跃表的节点按照分值从小到大排序，因此在插入和删除节点时需要保证跳跃表的有序性。跳跃表的节点和层数是动态生成的，因此跳跃表的性能非常优秀，在实现 Redis 的有序集合等功能时，跳跃表是一个非常重要的数据结构。

```shell
+------+                                      +------+
| head |------------------------------------->| tail |
+------+                                      +------+
|  key |  score  | backward | forward | span  |  key |  score  | backward | forward | span  |
+------+---------+----------+---------+-------+------+---------+----------+---------+-------+
|      |         |          |         |       |      |         |          |         |       |
|      |         |          |         |       |      |         |          |         |       |
|      |         |          |         |       |      |         |          |         |       |
|      |         |          |         |       |      |         |          |         |       |
|      |         |          |         |       |      |         |          |         |       |
+------+---------+----------+---------+-------+------+---------+----------+---------+-------+
```

在上述示意图中，跳跃表由头节点和尾节点组成，中间包含了多个节点。每个节点包含了键值、分值、前进指针、后退指针和跨度等信息。节点按照分值从小到大排序，前进指针指向分值大于当前节点的最小节点，后退指针指向分值小于当前节点的最大节点。跨度是当前节点到下一个节点之间的节点数量，用于优化跳跃表的查询性能。跳跃表的层数是动态生成的，可以根据节点数量和分值范围动态调整。


## 实现细节
Redis 中跳跃表的实现非常复杂，包括节点的插入、删除、查找等操作，还包括跳跃表层数的动态调整等。

以下是相关源代码文件的摘要和链接：

t_zset.c: 这个文件包含了跳跃表的各种操作，如插入、删除、查找等。[t_zset.c](https://github.com/redis/redis/blob/7.2/src/t_zset.c)
在 t_zset.c 中，你可以找到以下跳跃表操作的实现：
- zslCreate (创建跳跃表)
- zslFree (释放跳跃表)
- zslInsert (插入节点)
- zslDelete (删除节点)
- zslFind (查找节点)
- zslGetRank (获取节点的排名)
- zslDeleteRangeByScore (根据分数范围删除节点)
- zslDeleteRangeByRank (根据排名范围删除节点)




## 跨度和随机生成层数
Redis 中跳跃表的节点除了包含指向上下左右节点的指针外，还包含了跨度信息。跨度是指当前节点到下一个节点之间的节点数量，用于优化跳跃表的查询性能。另外，Redis 中跳跃表的层数是动态生成的，需要根据节点数量和分值范围动态调整。需要关注跨度和层数的生成和使用方式。


## 跳跃表的应用场景
Redis 中跳跃表的主要应用场景是实现有序集合。需要理解有序集合的数据结构和功能，以便于理解跳跃表在 Redis 中的应用。同时，需要关注跳跃表在其他场景中的应用，以便于理解和分析跳跃表的实现原理。
